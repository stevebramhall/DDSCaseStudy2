---
title: "Employe Attrition Study"
author: "Steve Bramhall, Hayley Horn"
date: "December 5, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE) # each code chunk will have their own echo control
```

```{r message=FALSE, warning=FALSE}
# Load Libraries
library(dplyr)      # for string functions
library(ggplot2)    # for plots
library(kableExtra) # for table formatting
library(knitr)      # for presenting in html
library(Hmisc)      # for describing data
library(caret)      # for classification & regression training
library(mlr)        # for machine learing
library(class)      # for classification funtions
library(corrplot)   # for correlation matrix
library(data.table)
library(mltools)

```

<h4>Abstract</h4>
Employees are valuable assets of an organization, and the unexpected departure of a key employee can be disruptive and costly. Employee Benefit News (EBN) reports that it costs employers 33% of a worker's annual salary to hire a replacement if that worker leaves. An internal measure of factors associated with an employee's potential attrition can help management either intervene or mitigate the disruption caused by unplanned staff turnover. This analysis is designed to identify determinants factors of employee attrition. A range of variables were reviewed that fell under the following categories: tenure, training and development opportunities, compensation, management/leadership, work environment, social support, and some attitudindal measures.<br>

The study reached the conclusion that there are certain indicators, that when present are a reasonable indicator that an employee shows signs consistent with attrition. There are also additional findings that hint to was to improve employee retention, which are opportunities to retain staff and reduce the risk of attrition.

<h4>Keywords</h4>
Talent Mangement, Employee Attrition, Determining Factors, Retention

<h4>Data Input</h4>
The training and validation data sets were read into data frames. We combined the data frames to one data frame to clean all the data at the same time.
```{r echo = TRUE}
# Read employee data from the training csv file and name the dataset train.
train <- read.csv(".\\InputFiles\\CaseStudy2-data.csv",header=TRUE,stringsAsFactors = TRUE,sep=",",encoding = "UTF-8")

# Read employee data from the validation csv file and names the dataset train.
validation <- read.csv(".\\InputFiles\\CaseStudy2Validation.csv",header=TRUE,stringsAsFactors = TRUE,sep=",",encoding = "UTF-8")

alldata = rbind(train,validation) # create dataframe with all data to clean all at same time

#Histograms of Numeric Data
par(mfrow=c(2,2))
hist(alldata$DistanceFromHome)
hist(alldata$Education)
hist(alldata$EnvironmentSatisfaction)
hist(alldata$JobInvolvement)
par(mfrow=c(2,2))
hist(alldata$JobLevel)
hist(alldata$JobSatisfaction)
hist(alldata$MonthlyIncome)
hist(alldata$NumCompaniesWorked)
par(mfrow=c(2,2))
hist(alldata$PercentSalaryHike)
hist(alldata$PerformanceRating)
hist(alldata$RelationshipSatisfaction)
par(mfrow=c(2,2))
hist(alldata$StockOptionLevel)
hist(alldata$TotalWorkingYears)
hist(alldata$TrainingTimesLastYear)
hist(alldata$WorkLifeBalance)
par(mfrow=c(2,2))
hist(alldata$YearsAtCompany)
hist(alldata$YearsInCurrentRole)
hist(alldata$YearsSinceLastPromotion)
hist(alldata$YearsWithCurrManager)

```

<h4>Data Exploration</h4>
There are 1170 observations with 37 variables (9 factors, 27 integers, 1 random number)

The following initial assessments/actions were completed:<br>
- Reviewed the data to confirm factor/categorical variable values exist in both.<br>
- Removed variables where all values are the same: StandardHours, EmployeeCount, Over18<br>
- Removed unrelated variable Rand<br>
- Recoded Attrition to 0=No, 1=Yes<br>

```{r DE}
# HMisc provides more details than str
#Hmisc::describe(alldata, digits = 2, tabular = TRUE)
# There are 1170 observations with 37 variables (9 factors, 27 integers, 1 random number)

# Reviewed train and validate data to confirm factor/categorical variable values exist in both
# Remove variables where all values are the same: StandardHours, EmployeeCount, Over18
# Remove unrelated variable Rand
alldata <- select(alldata,-c(StandardHours, EmployeeCount, Over18, Rand))

##Manually created data dictionary based on results below with a notes field
#DataDict <- read.csv(".\\InputFiles\\DataDictionary",header=TRUE,sep=",",encoding = "UTF-8")

```

<h4>Looked for multicollinear variables to remove</h4>
We found colinearity with following and removed one of the variables.
- Monthly Income (removed)
- Age            (removed)
- Job Level

- Years with Current Mangaer 
- Total Working Years        (removed)
- Years Since Last Promotion (removed)
- Years in Current Role      (removed)
- Years at Company           (removed)

```{r}

scatterplot <- ggplot(alldata, aes(MonthlyRate,MonthlyIncome,col=Attrition)) +
  geom_point() + coord_flip() +                                                             # make horizontal scatter plot
  ggtitle("Fig 5 - Employee ID vs Montly Income") +                                                          # add title
  theme(plot.title = element_text(color="dark blue",hjust=0.5)) +                           # format main title
  xlab("Montl") +  ylab("Bitterness") +                                           # add axis labels
  theme(axis.title.x = element_text(color="dark blue")) +                                   # format x title
  theme(axis.title.y = element_text(color="dark blue"))                                     # format y title

#linear fit by lm to scatterplot
scatterplot+geom_smooth(method = "lm", colour = "black", fill="yellow")


# Split data to create 2 correlation matrices, more readable
data2<-alldata;                                                                           # create 1st data set for corr matrix
data2$Attrition <- ifelse(data2[,3] == "Yes", 1, ifelse(data2[,3] == "No", 0, 99))        # Recode Attrition with 0s and 1s
data3<-data2;                                                                             # create 2nd data set for corr matrix
data2[21:33]<-list(NULL)                                                                  # reduce 1st data set
data3[2]<-list(NULL)                                                                      # reduce 2nd data set, keeping  Attrition
data3[3:19]<-list(NULL)

M_df1 <- select_if(data2, is.numeric)                                                     # get all numeric data
M1 <- cor(M_df1)                                                                          # convert to matrix
corrplot(M1, order="hclust",addrect=2)                                                    # Display the correlation coefficient

M_df2 <- select_if(data3, is.numeric)                                                     # get all numeric data
M2 <- cor(M_df2)                                                                          # convert to matrix
corrplot(M2, order="hclust",addrect=2)                                                    # Display the correlation coefficient

#-----

data4<-alldata;                                                                           # create 1st data set for corr matrix
data4$Attrition <- ifelse(data4[,3] == "Yes", 1, ifelse(data4[,3] == "No", 0, 99))        # Recode Attrition with 0s and 1s

data4<-data4[,-2]                                                                         # remove age
data4<-data4[,-18]                                                                        # remove monthly income
data4<-data4[,-23]                                                                        # remove total working years
data4<-data4[,-29]                                                                        # remove years since last promotion
data4<-data4[,-28]                                                                        # remove years in current role
data4<-data4[,-27]                                                                        # remove years at company

M_df3 <- select_if(data4, is.numeric)                                                     # get all numeric data
M3 <- cor(M_df3)                                                                          # convert to matrix
corrplot(M1, order="hclust",addrect=2)                                                    # Display the correlation coefficient

data3[2]<-list(NULL)  

train2 <- data4[1:1170,]                                                                  # Create new training set
train2$Attrition <- as.factor(ifelse(train2[,2] == 1, "Yes", ifelse(train2[,2] == 0, "No", 99)))     # Recode Attrition back to Yes and No

```

```{r}
# Attrition by Gender
ggplot(alldata,aes(x=Gender,fill=Attrition)) +
  ggtitle("Attrition by Gender") + ylab("Count") +                                          # add main & axis titles
  scale_fill_brewer(palette="Paired")+ theme_minimal() +                                    # change color palette
  geom_bar(aes(y = (..count..)),position=position_dodge()) +                                # side-by-side bars
  geom_text(aes(y = (..count..),label =   ifelse((..count..)==0,"",                         # label bars by %
            scales::percent((..count..)/sum(..count..)))), stat="count",
            position=position_dodge(width=0.9),vjust=-0.25)
```

```{r}
# Attrition by Department
ggplot(alldata,aes(x=Department,fill=Attrition)) +
  ggtitle("Attrition by Department") + ylab("Count") +                                      # add main & axis titles
  scale_fill_brewer(palette="Paired")+ theme_minimal() +                                    # change color palette
  geom_bar(aes(y = (..count..)),position=position_dodge()) +                                # side-by-side bars
  geom_text(aes(y = (..count..),label =   ifelse((..count..)==0,"",                         # label bars by %
            scales::percent((..count..)/sum(..count..)))), stat="count",
            position=position_dodge(width=0.9),vjust=-0.25)
```

```{r}
# Attrition by Age
ggplot(alldata,aes(x=JobLevel,fill=Attrition)) +
  ggtitle("Attrition by Age") + ylab("Count") +                                             # add main & axis titles
  scale_fill_brewer(palette="Paired")+ theme_minimal() +                                    # change color palette
  geom_bar(stat="count",position=position_dodge())                                          # side-by-side bars
      
```

```{r}
# Attrition by Travel Distance
ggplot(alldata,aes(x=DistanceFromHome,fill=Attrition)) +
  ggtitle("Attrition by Travel Distance") + ylab("Count") +                                 # add main & axis titles
  scale_fill_brewer(palette="Paired")+ theme_minimal() +                                    # change color palette
  geom_bar(stat="count",position=position_dodge())                                          # side-by-side bars
      
```

```{r}
# Attrition by Travel Education
ggplot(alldata,aes(x=Education,fill=Attrition)) +
  ggtitle("Attrition by Education") + ylab("Count") +                                       # add main & axis titles
  scale_fill_brewer(palette="Paired")+ theme_minimal() +                                    # change color palette
  geom_bar(aes(y = (..count..)),position=position_dodge()) +                                # side-by-side bars
  geom_text(aes(y = (..count..),label =   ifelse((..count..)==0,"",                         # label bars by %
            scales::percent((..count..)/sum(..count..)))), stat="count",
            position=position_dodge(width=0.9),vjust=-0.25)
```

```{r}
ggplot(alldata,aes(x=EducationField,fill=Attrition)) +
  ggtitle("Attrition by Education Field") + ylab("Count") +                                 # add main & axis titles
  scale_fill_brewer(palette="Paired")+ theme_minimal() +                                    # change color palette
  geom_bar(aes(y = (..count..)),position=position_dodge()) +                                # side-by-side bars
  geom_text(aes(y = (..count..),label =   ifelse((..count..)==0,"",                         # label bars by %
            scales::percent((..count..)/sum(..count..)))), stat="count",
            position=position_dodge(width=0.9),vjust=-0.25)
      
```

```{r}
ggplot(alldata,aes(x=JobSatisfaction,fill=Attrition)) +
  ggtitle("Attrition by JobSatisfaction") + ylab("Count") +                                 # add main & axis titles
  scale_fill_brewer(palette="Paired")+ theme_minimal() +                                    # change color palette
  geom_bar(aes(y = (..count..)),position=position_dodge()) +                                # side-by-side bars
  geom_text(aes(y = (..count..),label =   ifelse((..count..)==0,"",                         # label bars by %
            scales::percent((..count..)/sum(..count..)))), stat="count",
            position=position_dodge(width=0.9),vjust=-0.25) 
      
```

```{r}
ggplot(alldata,aes(x=JobRole,fill=Attrition)) +
  ggtitle("Attrition by Job Role") + ylab("Count") +                                        # add main & axis titles
  scale_fill_brewer(palette="Paired")+ theme_minimal() +                                    # change color palette
  geom_bar(aes(y = (..count..)),position=position_dodge()) +                                # side-by-side bars
  geom_text(aes(y = (..count..),label =   ifelse((..count..)==0,"",                         # label bars by %
            scales::percent((..count..)/sum(..count..)))), stat="count",
            position=position_dodge(width=0.9),vjust=-0.25) +
  theme(axis.text.x=element_text(angle=70,hjust=1))
      
```

```{r}
ggplot(alldata,aes(x=JobLevel,fill=Attrition)) +
  ggtitle("Attrition by Job Level") + ylab("Count") +                                       # add main & axis titles
  scale_fill_brewer(palette="Paired")+ theme_minimal() +                                    # change color palette
  geom_bar(aes(y = (..count..)),position=position_dodge()) +                                # side-by-side bars
  geom_text(aes(y = (..count..),label =   ifelse((..count..)==0,"",                         # label bars by %
            scales::percent((..count..)/sum(..count..)))), stat="count",
            position=position_dodge(width=0.9),vjust=-0.25) +
  theme(axis.text.x=element_text(angle=70,hjust=1))
      
```


```{r}
#### Historgrams for Age and Monthly Income
par(mfrow=c(1,2))
hist(train$Age, main="Histogram for Age", xlab="Age", col="blue", las=1, breaks=10)
hist(train$MonthlyIncome, main="Histogram for Monthly Income", xlab="Monthly Income", 
     xlim=c(2000,20000), ylim=c(0,400), col="green", las=1, breaks=25)
```
#### The histogram for Age shows a relatively normal distribution. Managment incomce provides a right skew of the Monthly Income histogram.There are more lower monthly incomes compared to management's higher income.



```{r}
# function to normalize data for KNN
normalize <- function(x) {
  y <- (x-min(x))/(max(x)-min(x))
  y
}

keyvars=c(2,9,10,11,12,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,45,46,47,48,49,51,52,53,54,55,56,57,58)

# No categorical variables selected
train.dummies <- one_hot(as.data.table(train))                            # Create dummy vars for categories
val.dummies  <- one_hot(as.data.table(validation))  

train_n <- lapply(train.dummies[,c(2,9,10,11,12,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,45,46,47,48,49,51,52,53,54,55,56,57,58)],normalize)                            # normalize numeric data
val_n <- lapply(val.dummies[,c(2,9,10,11,12,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,45,46,47,48,49,51,52,53,54,55,56,57,58)],normalize)

#train_n <- lapply(train[,c(2,7,12,15,16)],normalize)                       # normalize numeric data
#val_n <- lapply(validation[,c(2,7,12,15,16)],normalize)

dfTrain <- data.frame(train_n)                                             # create dataframe of normalized data
dfVal <- data.frame(val_n)

rownames(dfTrain) <- train$ID                                              # add IDs
rownames(dfVal) <- validation$ID

train.attrition <- train$Attrition                                         # isolate attrition
val.attrition <- validation$Attrition

names(train.attrition) <- train$ID                                         # add IDs
names(val.attrition) <- validation$ID

dfTrain[1:4]                                                               # check normalized data
dfVal[1:4]

valIDs <- rownames(dfVal)

train.attrition[1:10]                                                      # check data
val.attrition[1:10]
```

<h4> Execution of Model and Results</h4>

```{r}
k<-3

#loops=11
#while(k < loops) {                                                                        # looping due to minor variation between runs
  pred <- knn(dfTrain,dfVal,cl=train.attrition,k)                                         # run knn model
  result=confusionMatrix(table(val.attrition,pred))                                       # store confusion matrix
#  chk1=result$overall['Accuracy']
#  chk2=result$byClass['Specificity']

#  if (k == 1) {
#    bestk <- k
#    best.result <- result                                                                 # store 1st run as best results
#    dfPred <- data.frame(pred)                                                            # store predictions
#  }
#  else if (result$byClass['Specificity'] > best.result$byClass['Specificity']) {          # check for best specificity
#    bestk <- k
#    best.result <- result                                                                 # replace best results
    dfPred <- data.frame(pred)                                                            # replace best predictions
#  }
#  k=k+1
#}

#bestk
#best.result
result
```

```{r}
# Output Prediction File
dfPred <- data.frame(dfPred)                     # create dataframe of normalized data
dfPred$ID <- valIDs                              # add IDs
dfPred <- dfPred[,c(2,1)]
names(dfPred) <- c("ID","PredictedAttrition")

#write.csv(dfPred,"dfPred.csv",row.names=FALSE)
```


